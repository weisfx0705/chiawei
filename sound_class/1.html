<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Calibration Lab｜數位音效設計</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');

    body {
      font-family: 'Noto Sans TC', sans-serif;
    }

    .animate-fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body class="bg-slate-900 text-slate-200">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- Lucide Icons Shim ---
    const IconBase = ({ size = 24, className, children, ...props }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
    );
    const Volume2 = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></IconBase>;
    const VolumeX = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></IconBase>;
    const Lock = (props) => <IconBase {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></IconBase>;
    const Unlock = (props) => <IconBase {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></IconBase>;
    const Play = (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"></polygon></IconBase>;
    const Pause = (props) => <IconBase {...props}><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></IconBase>;
    const Square = (props) => <IconBase {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></IconBase>;
    const Info = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></IconBase>;
    const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></IconBase>;
    const RotateCcw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></IconBase>;
    const BookOpen = (props) => <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 1-4 4v14a3 3 0 0 0 3-3h7z"></path></IconBase>;
    // --- End Icons Shim ---

    // --- Components ---
    const Knob = ({ value, min = 0, max = 100, onChange, size = 120, disabled = false, locked = false }) => {
      const knobRef = useRef(null);
      const isDragging = useRef(false);
      const startY = useRef(0);
      const startValue = useRef(0);

      // Common logic to update value based on Y position
      const updateValue = (clientY) => {
        const deltaY = startY.current - clientY; // Drag up to increase
        const sensitivity = 0.5; // Values per pixel

        let newValue = startValue.current + deltaY * sensitivity;
        newValue = Math.min(Math.max(newValue, min), max);
        onChange(newValue);
      };

      // --- MOUSE EVENTS ---
      const handleMouseDown = (e) => {
        if (disabled) return;
        isDragging.current = true;
        startY.current = e.clientY;
        startValue.current = value;
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        e.preventDefault(); // Prevent text selection
      };

      const handleMouseMove = (e) => {
        if (!isDragging.current) return;
        updateValue(e.clientY);
      };

      const handleMouseUp = () => {
        isDragging.current = false;
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      };

      // --- TOUCH EVENTS ---
      const handleTouchStart = (e) => {
        if (disabled) return;
        isDragging.current = true;
        // Use the first touch point
        startY.current = e.touches[0].clientY;
        startValue.current = value;

        // Add passive: false to allow preventing default (scrolling)
        document.addEventListener('touchmove', handleTouchMove, { passive: false });
        document.addEventListener('touchend', handleTouchEnd);
      };

      const handleTouchMove = (e) => {
        if (!isDragging.current) return;
        // Prevent scrolling while dragging the knob
        if (e.cancelable) e.preventDefault();
        updateValue(e.touches[0].clientY);
      };

      const handleTouchEnd = () => {
        isDragging.current = false;
        document.removeEventListener('touchmove', handleTouchMove);
        document.removeEventListener('touchend', handleTouchEnd);
      };

      // Calculate rotation: 0% = -135deg, 100% = +135deg. Total 270deg range.
      const rotation = ((value - min) / (max - min)) * 270 - 135;

      return (
        <div
          className={`relative select-none flex flex-col items-center touch-none ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-ns-resize'}`}
          style={{ width: size, height: size + 40 }} // Extra space for label
          onMouseDown={handleMouseDown}
          onTouchStart={handleTouchStart}
        >
          <div className="relative" style={{ width: size, height: size }}>
            {/* Bg Track */}
            <div className="absolute inset-0 rounded-full border-4 border-slate-700 bg-slate-900"></div>

            {/* Knob Body */}
            <div
              ref={knobRef}
              className={`absolute inset-2 rounded-full shadow-2xl flex items-center justify-center border transition-colors duration-75 
                 ${locked
                  ? 'bg-gradient-to-br from-red-900 to-slate-900 border-red-700'
                  : 'bg-gradient-to-br from-slate-700 to-slate-900 border-slate-600 hover:border-sky-500/50'
                }`}
              style={{ transform: `rotate(${rotation}deg)` }}
            >
              {/* Marker Indicator */}
              <div className={`w-1.5 h-[40%] absolute top-2 rounded-full shadow-lg ${locked ? 'bg-red-500' : 'bg-sky-500'}`}></div>
            </div>
          </div>

          {/* Value Display */}
          <div className="mt-4 font-mono text-xl font-bold text-sky-400">
            {Math.round(value)}%
          </div>
        </div>
      );
    };

    const AudioCalibrationLab = () => {
      const [mode, setMode] = useState('calibration'); // 'calibration' or 'reference'
      const [targetStandard, setTargetStandard] = useState('film'); // 'film' or 'tv'
      // ... (rest of state remains same)

      // --- Calibration State ---
      const [pinkNoiseOn, setPinkNoiseOn] = useState(false);
      const [speakerVolume, setSpeakerVolume] = useState(0); // 0 to 100
      const [splReading, setSplReading] = useState(40); // Base ambient noise
      const [isCalibrated, setIsCalibrated] = useState(false);

      // --- Reference State ---
      const [volumeLocked, setVolumeLocked] = useState(false);
      const [refSuccess, setRefSuccess] = useState(false);
      const [isVideoPlaying, setIsVideoPlaying] = useState(false);

      // Refs
      const audioContextRef = useRef(null);
      const oscillatorRef = useRef(null);
      const gainNodeRef = useRef(null);
      const videoRef = useRef(null); // Native Video Reference

      // --- Audio Logic (Pink Noise) ---
      useEffect(() => {
        // Update Gain (Volume) in real-time for Pink Noise
        if (gainNodeRef.current) {
          // Convert 0-100 linear knob to logarithmic-like gain for natural feel
          gainNodeRef.current.gain.value = speakerVolume / 100;
        }
      }, [speakerVolume]);

      useEffect(() => {
        return () => stopSound();
      }, []);

      // --- SPL Calculation Logic ---
      useEffect(() => {
        const calculateSPL = () => {
          const fluctuation = Math.random() * 0.5 - 0.25;
          let targetSPL = 40;

          if (pinkNoiseOn) {
            if (speakerVolume > 0) {
              targetSPL = 40 + (speakerVolume / 100) * 65;
            }
          }

          // Smooth transition
          setSplReading(prev => {
            const diff = targetSPL - prev;
            return prev + diff * 0.2 + fluctuation;
          });
        };

        const interval = setInterval(calculateSPL, 100);
        return () => clearInterval(interval);
      }, [pinkNoiseOn, speakerVolume]);

      // Check for success in Calibration

      useEffect(() => {
        let isSuccess = false;
        if (targetStandard === 'film') {
          // Film: Target 85dB
          if (Math.abs(splReading - 85) < 1.5) isSuccess = true;
        } else {
          // TV: Target 77-78dB (allowing slight fluctuation)
          if (splReading >= 76.5 && splReading <= 78.5) isSuccess = true;
        }

        if (isSuccess && pinkNoiseOn) {
          setIsCalibrated(true);
        } else {
          setIsCalibrated(false);
        }
      }, [splReading, pinkNoiseOn, targetStandard]);

      // --- Web Audio API (Pink Noise) ---
      const startPinkNoise = () => {
        if (!window.AudioContext && !window.webkitAudioContext) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;

        if (!audioContextRef.current) {
          audioContextRef.current = new AudioContext();
        }

        const ctx = audioContextRef.current;

        let gainNode = gainNodeRef.current;
        if (!gainNode) {
          gainNode = ctx.createGain();
          gainNode.gain.value = speakerVolume / 100;
          gainNode.connect(ctx.destination);
          gainNodeRef.current = gainNode;
        } else {
          // Ensure it's active
          if (ctx.state === 'suspended') ctx.resume();
        }

        const bufferSize = 4096;
        const pinkNoise = (function () {
          let b0, b1, b2, b3, b4, b5, b6;
          b0 = b1 = b2 = b3 = b4 = b5 = b6 = 0.0;
          const node = ctx.createScriptProcessor(bufferSize, 1, 1);
          node.onaudioprocess = function (e) {
            const output = e.outputBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
              const white = Math.random() * 2 - 1;
              b0 = 0.99886 * b0 + white * 0.0555179;
              b1 = 0.99332 * b1 + white * 0.0750759;
              b2 = 0.96900 * b2 + white * 0.1538520;
              b3 = 0.86650 * b3 + white * 0.3104856;
              b4 = 0.55000 * b4 + white * 0.5329522;
              b5 = -0.7616 * b5 - white * 0.0168980;
              output[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
              output[i] *= 0.11;
              b6 = white * 0.115926;
            }
          };
          return node;
        })();

        pinkNoise.connect(gainNode);
        oscillatorRef.current = pinkNoise;
        setPinkNoiseOn(true);
      };

      const stopSound = () => {
        if (oscillatorRef.current) {
          oscillatorRef.current.disconnect();
          oscillatorRef.current = null;
        }
        setPinkNoiseOn(false);
      };

      const togglePinkNoise = () => {
        if (pinkNoiseOn) {
          stopSound();
        } else {
          startPinkNoise();
        }
      };

      // --- HTML5 Video Integration ---
      const videoSourceRef = useRef(null);

      // Initialize/Connect Video Audio via Web Audio API (Bypassing iOS volume restrictions)
      const connectVideoAudio = () => {
        if (!videoRef.current) return;

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!audioContextRef.current) {
          audioContextRef.current = new AudioContext();
        }
        const ctx = audioContextRef.current;

        // Ensure GainNode exists and is set to current volume
        if (!gainNodeRef.current) {
          const gainNode = ctx.createGain();
          gainNode.gain.value = speakerVolume / 100;
          gainNode.connect(ctx.destination);
          gainNodeRef.current = gainNode;
        }

        // Create MediaElementSource only once to avoid errors
        if (!videoSourceRef.current) {
          try {
            // Create source from video element
            const source = ctx.createMediaElementSource(videoRef.current);
            source.connect(gainNodeRef.current);
            videoSourceRef.current = source;
          } catch (e) {
            console.error("Audio Context Error (likely CORS):", e);
          }
        }

        // Resume context if suspended (browser autoplay policy)
        if (ctx.state === 'suspended') {
          ctx.resume();
        }
      };

      const toggleVideoPlay = () => {
        if (videoRef.current) {
          if (videoRef.current.paused) {
            // Initialize AudioContext before playing
            connectVideoAudio();
            videoRef.current.play();
            setIsVideoPlaying(true);
          } else {
            videoRef.current.pause();
            setIsVideoPlaying(false);
          }
        }
      };

      const resetAll = () => {
        setSpeakerVolume(0);
        setSplReading(40);
        setIsCalibrated(false);
        setVolumeLocked(false);
        setRefSuccess(false);
        setIsVideoPlaying(false);
        stopSound();
        if (videoRef.current) {
          videoRef.current.pause();
          videoRef.current.currentTime = 180;
        }
      };

      return (
        <div className="min-h-screen bg-slate-900 text-slate-200 font-sans p-4 md:p-8 flex flex-col items-center select-none">

          {/* Back Link */}
          <div className="w-full max-w-5xl mb-4">
            <a href="index.html" className="inline-flex items-center text-slate-400 hover:text-white font-bold transition-colors text-sm">
              <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
              </svg>
              回總整理
            </a>
          </div>

          {/* Header */}
          <header className="w-full max-w-5xl mb-8 flex flex-col md:flex-row justify-between items-center border-b border-slate-700 pb-4 gap-4">
            <div>
              <h1 className="text-2xl font-bold text-sky-400">舉手！喇叭到底要開多大聲啊？</h1>
              <p className="text-sm text-slate-400">互動式學習：了解硬體與訊號的關係</p>
            </div>
            <div className="flex gap-2">
              <button
                onClick={() => { setMode('calibration'); stopSound(); setSpeakerVolume(0); setIsCalibrated(false); }}
                className={`px-4 py-2 rounded-lg font-medium transition ${mode === 'calibration' ? 'bg-sky-600 text-white' : 'bg-slate-800 hover:bg-slate-700'}`}
              >
                1. 科學測量法
              </button>
              <button
                onClick={() => { setMode('reference'); stopSound(); setSpeakerVolume(30); setVolumeLocked(false); setIsVideoPlaying(false); }}
                className={`px-4 py-2 rounded-lg font-medium transition ${mode === 'reference' ? 'bg-emerald-600 text-white' : 'bg-slate-800 hover:bg-slate-700'}`}
              >
                2. 相對參考法
              </button>
            </div>
          </header>

          {/* Main Workspace */}
          {/* Changed to flex-col to allow footer notes inside the card */}
          <div className="w-full max-w-5xl bg-slate-950 rounded-xl shadow-2xl border border-slate-800 overflow-hidden flex flex-col relative">

            {/* === SCENARIO 1: CALIBRATION === */}
            {mode === 'calibration' && (
              <>
                <div className="flex flex-col md:flex-row w-full border-b border-slate-800">
                  {/* Left Panel: Digital Source (Computer) */}
                  <div className="flex-1 p-6 border-r border-slate-800 bg-slate-900/50">
                    <div className="flex items-center gap-2 mb-4">
                      <div className="w-3 h-3 rounded-full bg-sky-500"></div>
                      <h2 className="font-bold text-lg">訊號源 (Input Signal)</h2>
                    </div>

                    <div className="bg-slate-800 p-4 rounded-lg mb-6">
                      <p className="text-xs text-slate-400 mb-2">DAW Output Meter (dBFS)</p>
                      <div className="flex gap-4 items-end h-40 justify-center">
                        {/* Single Meter Bar for simplicity */}
                        <div className="w-12 bg-slate-950 rounded relative h-full overflow-hidden border border-slate-700">
                          <div className="absolute top-2 right-1 text-[10px] text-slate-500 z-10">0</div>
                          <div className="absolute top-[30%] right-1 text-[10px] text-slate-500 z-10">-20</div>
                          <div
                            className={`w-full absolute bottom-0 transition-all duration-100 ${pinkNoiseOn ? 'h-[70%] bg-sky-400 shadow-[0_0_15px_rgba(56,189,248,0.6)]' : 'h-0 bg-sky-900'}`}
                          ></div>
                        </div>
                      </div>
                      <div className="text-center mt-2 text-mono text-sky-400 font-bold">
                        {pinkNoiseOn ? '-20.0 dBFS' : '- inf'}
                      </div>
                    </div>

                    <div className="space-y-4">
                      <div className="bg-slate-800 p-4 rounded-lg">
                        <h3 className="font-semibold mb-2 flex items-center gap-2">
                          <Square size={16} /> 粉紅噪音產生器
                        </h3>
                        <button
                          onClick={togglePinkNoise}
                          className={`w-full py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition ${pinkNoiseOn ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}`}
                        >
                          {pinkNoiseOn ? '停止發送訊號' : '開啟 Pink Noise (-20dB)'}
                        </button>
                      </div>
                    </div>
                  </div>

                  {/* Middle Panel: Physical Room (Speakers) */}
                  <div className="flex-1 p-6 border-r border-slate-800 flex flex-col items-center justify-center bg-gradient-to-b from-slate-900 to-slate-950">
                    <h2 className="font-bold text-lg mb-6">擴大機與喇叭 (Hardware)</h2>

                    {/* Speaker Graphic */}
                    <div className="mb-8 relative">
                      <Volume2
                        size={80}
                        className={`transition-all duration-100 ${pinkNoiseOn && speakerVolume > 5
                          ? 'text-sky-400 drop-shadow-[0_0_10px_rgba(56,189,248,0.8)]'
                          : 'text-slate-700'
                          }`}
                        strokeWidth={pinkNoiseOn && speakerVolume > 5 ? 2.5 : 1.5}
                      />
                      {/* Sound Waves Animation */}
                      {pinkNoiseOn && speakerVolume > 5 && (
                        <div className="absolute -right-4 top-0 bottom-0 flex items-center">
                          <div className="w-1 h-8 bg-sky-400/50 rounded-full animate-ping" style={{ animationDuration: '0.5s' }}></div>
                        </div>
                      )}

                      {speakerVolume === 0 && (
                        <div className="absolute -right-6 top-1/2 -translate-y-1/2 bg-red-500/20 text-red-400 text-xs px-2 py-1 rounded">
                          Muted
                        </div>
                      )}
                    </div>

                    {/* Volume Knob */}
                    <Knob
                      value={speakerVolume}
                      onChange={setSpeakerVolume}
                    />

                    <div className="mt-2 text-xs text-slate-500">
                      點擊並上下拖動旋鈕調整音量
                    </div>

                  </div>

                  {/* Right Panel: SPL Meter (Measurement) */}
                  <div className="flex-1 p-6 flex flex-col items-center bg-slate-900/50">
                    <div className="flex items-center gap-2 mb-4">
                      <div className="w-3 h-3 rounded-full bg-emerald-500"></div>
                      <h2 className="font-bold text-lg">音壓計 (SPL Meter)</h2>
                    </div>

                    {/* Standard Selector */}
                    <div className="flex bg-slate-800 p-1 rounded-lg mb-4 w-full">
                      <button
                        onClick={() => setTargetStandard('film')}
                        className={`flex-1 py-1 text-xs rounded-md transition ${targetStandard === 'film' ? 'bg-sky-600 text-white' : 'text-slate-400 hover:text-white'}`}
                      >
                        電影 (85dB)
                      </button>
                      <button
                        onClick={() => setTargetStandard('tv')}
                        className={`flex-1 py-1 text-xs rounded-md transition ${targetStandard === 'tv' ? 'bg-sky-600 text-white' : 'text-slate-400 hover:text-white'}`}
                      >
                        電視 (77~78dB)
                      </button>
                    </div>

                    {/* SPL Display */}
                    <div className="bg-black border-8 border-slate-700 rounded-2xl p-6 w-full max-w-[200px] mb-6 shadow-inner relative flex flex-col items-center">
                      <div className="text-slate-500 text-[10px] w-full text-right mb-1">C-Weighting / Slow</div>
                      <div className={`font-mono text-5xl text-center font-bold tracking-wider ${isCalibrated ? 'text-green-500' : 'text-red-500'}`}>
                        {splReading.toFixed(1)}
                      </div>
                      <div className="text-slate-500 w-full text-right mt-1 font-mono">dB</div>
                    </div>

                    <div className="bg-slate-800 p-4 rounded-lg text-center w-full">
                      <h4 className="text-slate-300 font-bold mb-2">任務指示 ({targetStandard === 'film' ? '電影標準' : '電視標準'})</h4>
                      <ul className="text-sm text-slate-400 space-y-2 text-left list-disc list-inside">
                        <li className={pinkNoiseOn ? 'text-green-400' : ''}>開啟左側訊號 (-20dBFS)</li>
                        <li className={speakerVolume > 0 ? 'text-green-400' : ''}>慢慢轉動中間的音量旋鈕</li>
                        <li className={isCalibrated ? 'text-green-400 font-bold' : ''}>
                          使音壓計讀數達到 {targetStandard === 'film' ? '85dB' : '77dB ~ 78dB'}
                        </li>
                      </ul>
                    </div>

                    {isCalibrated && (
                      <div className="mt-6 bg-green-500/20 text-green-300 p-4 rounded-lg border border-green-500/50 flex items-center gap-2 animate-bounce">
                        <CheckCircle />
                        校準完成！
                      </div>
                    )}
                  </div>
                </div>

                {/* Added Footer Note for Pro Context */}
                <div className="p-6 bg-slate-900/50 text-slate-400 text-sm border-t border-slate-800">
                  <div className="flex gap-3">
                    <div className="mt-1"><BookOpen size={18} className="text-sky-500" /></div>
                    <div className="space-y-2 leading-relaxed">
                      <h4 className="font-bold text-slate-300">專業監聽標準補充</h4>
                      <p>
                        在專業電影聲軌製作中，參考監聽標準必須以「單一聲道、單一喇叭」為校準對象，而非所有喇叭同時播放。
                        標準作法是由系統輸出 <strong>-20 dBFS 的粉紅噪音</strong>，每次只播放一個聲道（例如 Left、Center、Right…），
                        並在混音位置量測，使該喇叭單獨回放時達到 <strong>約 85 dB SPL（C-weighting、Slow）</strong>。
                        如此可確保每一個 channel 在相同能量基準下工作，避免因喇叭效率或空間差異造成錯誤判斷。
                      </p>
                      <p>
                        關於電視的思考，混音 TV 作品的近場監聽，應該開至 <strong>77dB ~ 78dB</strong> 即可。
                      </p>
                      <p>
                        若無音壓計，實務上可使用同類型、已完成的電影或戲劇作品作為相對參考，調整監聽音量至最自然且不吃力的位置，
                        並在整個工作流程中固定此音量設定，以建立可信的相對監聽基準。
                      </p>
                      <div className="pt-2 text-xs text-slate-500">
                        參考來源：
                        <a
                          href="https://cinemontage.org/technology-how-sound-crews-work-hard-to-get-the-right-levels-on-theatrical-mixes"
                          target="_blank"
                          rel="noreferrer"
                          className="text-sky-500 hover:text-sky-400 ml-1 underline decoration-sky-500/30"
                        >
                          Dolby 電影聲軌校準標準說明（英文）
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </>
            )}

            {/* === SCENARIO 2: REFERENCE METHOD === */}
            {mode === 'reference' && (
              <>
                <div className="w-full flex flex-col md:flex-row h-[600px] md:h-[500px]">

                  {/* Left: Direct Video Player */}
                  <div className="flex-[1.5] bg-black border-r border-slate-700 flex flex-col relative group">
                    <div className="absolute top-0 left-0 right-0 p-2 z-10 bg-gradient-to-b from-black/80 to-transparent flex justify-between items-center pointer-events-none">
                      <div className="text-emerald-400 font-bold flex items-center gap-2 px-2">
                        <Play size={16} /> Reference Project (Big Buck Bunny)
                      </div>
                    </div>

                    {/* HTML5 Video Element - No external API, no blocking */}
                    <video
                      ref={videoRef}
                      className="w-full h-full object-contain"
                      src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4#t=180"
                      poster="https://peach.blender.org/wp-content/uploads/title_anouncement.jpg?x11217"
                      loop
                      playsInline
                      crossOrigin="anonymous"
                      // Hide default controls to force user to use the UI button and knob
                      controls={false}
                    ></video>

                    {/* Custom Play/Pause Overlay */}
                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                      {!isVideoPlaying && (
                        <div className="bg-black/50 backdrop-blur-sm p-4 rounded-full text-white animate-pulse">
                          <Play size={48} fill="currentColor" />
                        </div>
                      )}
                    </div>

                    <div className="absolute bottom-6 left-0 right-0 flex justify-center z-20">
                      <button
                        onClick={toggleVideoPlay}
                        className="bg-emerald-600 hover:bg-emerald-500 text-white px-8 py-3 rounded-full font-bold shadow-lg flex items-center gap-2 transition-transform transform hover:scale-105 active:scale-95"
                      >
                        {isVideoPlaying ? <><Pause fill="currentColor" /> 暫停播放</> : <><Play fill="currentColor" /> 播放影片</>}
                      </button>
                    </div>
                  </div>

                  {/* Right: User's Monitoring Environment */}
                  <div className="flex-1 bg-slate-800 p-6 flex flex-col items-center justify-center relative">
                    <h2 className="text-lg font-bold mb-4 text-slate-200">你的監聽控制 (Monitoring)</h2>

                    <div className="bg-slate-900/50 p-3 rounded text-sm text-slate-400 mb-6 text-center border border-slate-700">
                      <Info size={14} className="inline mr-1 text-sky-400" />
                      找任何一個參考影片、匯入你的工作平台，播放影片，並閉上眼聆聽。<br />轉動旋鈕，直到你覺得<strong>聽得最舒服</strong>，如果覺得還是不夠大聲，必然是還要再調大你目前正在聆聽的音響輸出系統的音量。
                    </div>

                    {/* Knob */}
                    <div className="mb-6">
                      <Knob
                        value={speakerVolume}
                        onChange={setSpeakerVolume}
                        size={150}
                        disabled={volumeLocked}
                        locked={volumeLocked}
                      />
                    </div>

                    {/* Lock Button */}
                    <button
                      onClick={() => {
                        setVolumeLocked(!volumeLocked);
                        if (!volumeLocked) setRefSuccess(true);
                      }}
                      className={`w-full py-3 rounded-xl font-bold text-lg flex items-center justify-center gap-3 transition-all ${volumeLocked
                        ? 'bg-red-500 text-white shadow-lg shadow-red-500/30 ring-2 ring-red-400 ring-offset-2 ring-offset-slate-800'
                        : 'bg-emerald-600 hover:bg-emerald-500 text-white'
                        }`}
                    >
                      {volumeLocked ? <><Lock /> 已鎖定監聽音量</> : <><Unlock /> 確認音量並鎖定</>}
                    </button>

                    {refSuccess && volumeLocked && (
                      <div className="mt-4 text-center animate-fade-in">
                        <p className="text-xs text-slate-400 mb-1">校準完成</p>
                        <p className="text-emerald-400 text-sm font-bold">
                          現在這個旋鈕位置就是你的「相對可信的標準」。
                        </p>
                      </div>
                    )}
                  </div>
                </div>

                {/* Big Buck Bunny Info */}
                <div className="p-6 bg-slate-900/50 text-slate-400 text-sm border-t border-slate-800">
                  <div className="flex gap-3">
                    <div className="mt-1"><Info size={18} className="text-sky-500" /></div>
                    <div className="space-y-2 leading-relaxed">
                      <h4 className="font-bold text-slate-300">關於參考影片：Big Buck Bunny (2008)</h4>
                      <p>
                        本測試使用《Big Buck Bunny》作為參考素材。這是一部由 Blender 基金會製作的開放版權動畫短片（Open Movie）。
                        由於其畫面細緻且頻寬動態豐富，常被業界用來作為視訊編碼與音訊播放設備的標準測試影片。
                        在此處，我們利用其標準化的混音電平，協助你建立「相對聽感」的音量基準。
                      </p>
                      <div className="pt-2 text-xs text-slate-500">
                        來源網站：
                        <a
                          href="https://peach.blender.org/"
                          target="_blank"
                          rel="noreferrer"
                          className="text-sky-500 hover:text-sky-400 ml-1 underline decoration-sky-500/30"
                        >
                          Project Peach - Big Buck Bunny Official Site
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </>
            )}

          </div>

          {/* Footer / Reset */}
          <div className="mt-12 flex flex-col items-center gap-4">
            <button onClick={resetAll} className="flex items-center gap-2 text-slate-500 hover:text-white transition">
              <RotateCcw size={16} /> 重置實驗
            </button>

            <div className="text-slate-600 text-xs mt-2 border-t border-slate-800 pt-4 w-full text-center">
              義守大學電影與電視學系陳嘉暐老師課程提供
            </div>
          </div>

        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AudioCalibrationLab />);
  </script>
</body>

</html>