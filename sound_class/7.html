<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loudness & Metering｜數位音效設計</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
        }

        .meter-bar {
            transition: height 0.1s linear;
        }

        .meter-bar.slow {
            transition: height 0.5s ease-out;
        }

        .meter-bar.integrated {
            transition: height 1s linear;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons Shim ---
        const IconBase = ({ size = 24, className, children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Activity = (props) => <IconBase {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></IconBase>;
        const Info = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></IconBase>;
        const Youtube = (props) => <IconBase {...props}><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></IconBase>;
        const Tv = (props) => <IconBase {...props}><rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><polyline points="17 2 12 7 7 2"></polyline></IconBase>;
        const Mic = (props) => <IconBase {...props}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></IconBase>;
        const Laptop = (props) => <IconBase {...props}><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="2" y1="21" x2="22" y2="21"></line></IconBase>;

        // --- Main Component ---
        const LoudnessLab = () => {
            // Simulator State
            const [inputGain, setInputGain] = useState(-20); // dB
            const [isPlaying, setIsPlaying] = useState(false);

            // Meter Values
            const [momentary, setMomentary] = useState(-100);
            const [shortTerm, setShortTerm] = useState(-100);
            const [integrated, setIntegrated] = useState(-100);
            const [truePeak, setTruePeak] = useState(-100);

            // Accumulators for Integrated logic
            const integratedSumRef = useRef(0);
            const integratedCountRef = useRef(0);
            const shortTermBufferRef = useRef([]);

            // Simulation Loop
            useEffect(() => {
                let interval;
                if (isPlaying) {
                    interval = setInterval(() => {
                        // Simulate signal fluctuation based on input gain
                        // Signal varies between inputGain - 5 and inputGain + 2
                        const fluctuation = (Math.random() * 7) - 5;
                        const currentSignal = Math.max(-100, Math.min(0, inputGain + fluctuation));

                        // 1. Momentary (400ms window approximation)
                        // Fast reaction
                        setMomentary(currentSignal);

                        // 2. Short-term (3s window approximation)
                        // Smoother, moving average
                        const newBuffer = [...shortTermBufferRef.current, currentSignal];
                        if (newBuffer.length > 30) newBuffer.shift(); // Keep last ~3 sec (assuming 100ms interval)
                        shortTermBufferRef.current = newBuffer;

                        const avgShortTerm = newBuffer.reduce((a, b) => a + b, 0) / newBuffer.length;
                        setShortTerm(avgShortTerm);

                        // 3. Integrated (Start to Stop)
                        // Gating: Typically ignores silence below -70 LUFS (Simplified here)
                        if (currentSignal > -70) {
                            integratedSumRef.current += currentSignal;
                            integratedCountRef.current += 1;
                            setIntegrated(integratedSumRef.current / integratedCountRef.current);
                        }

                        // 4. True Peak
                        // Random spikes occasionally higher than signal
                        const peakSpike = Math.random() > 0.9 ? 1.5 : 0;
                        const currentPeak = currentSignal + peakSpike;
                        setTruePeak(prev => Math.max(prev, currentPeak));

                    }, 100);
                } else {
                    // Decay when stopped
                    setMomentary(-100);
                    // Short term decays slowly
                }
                return () => clearInterval(interval);
            }, [isPlaying, inputGain]);

            // Reset Integrated
            const resetMeters = () => {
                integratedSumRef.current = 0;
                integratedCountRef.current = 0;
                shortTermBufferRef.current = [];
                setIntegrated(-100);
                setTruePeak(-100);
            };

            const togglePlay = () => {
                if (isPlaying) {
                    setIsPlaying(false);
                } else {
                    if (integrated === -100) resetMeters();
                    setIsPlaying(true);
                }
            };

            // Helper to convert value to percentage for UI bar height (Limit range -60 to 0)
            const getBarHeight = (val) => {
                const min = -60;
                const max = 0;
                const clamped = Math.max(min, Math.min(max, val));
                return ((clamped - min) / (max - min)) * 100;
            };

            const getBarColor = (val, target = -14) => {
                if (val > -1) return 'bg-red-500 shadow-[0_0_10px_rgba(239, 68, 68, 0.8)]'; // Clipping risk
                if (Math.abs(val - target) < 1) return 'bg-green-400 shadow-[0_0_10px_rgba(74, 222, 128, 0.5)]'; // On Target
                if (val > target) return 'bg-yellow-400'; // Too loud
                return 'bg-blue-500'; // Too quiet
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-900 to-slate-800 pb-12 font-sans select-none">

                    {/* Navigation */}
                    <div className="bg-slate-950/50 border-b border-slate-700/50 sticky top-0 z-50 backdrop-blur-md">
                        <div className="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
                            <a href="index.html" className="inline-flex items-center text-slate-400 hover:text-white font-bold transition-colors text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                </svg>
                                回總整理
                            </a>
                            <div className="text-xs font-mono text-slate-500">Loudness & Metering</div>
                        </div>
                    </div>

                    <div className="max-w-6xl mx-auto px-4 py-8">

                        {/* Header */}
                        <header className="mb-12 text-center">
                            <h1 className="text-4xl md:text-5xl font-black mb-4 bg-gradient-to-r from-emerald-400 to-cyan-400 bg-clip-text text-transparent">
                                響度 Loudness
                            </h1>
                            <p className="text-slate-400 text-lg max-w-2xl mx-auto">
                                為什麼 YouTube 的聲音聽起來跟 Netflix 不一樣？<br />
                                掌握 <strong>LUFS</strong>，讓你的作品在所有平台上都聽起來專業且一致。
                            </p>
                        </header>

                        {/* SECTION 1: CONCEPTS */}
                        <section className="grid md:grid-cols-3 gap-6 mb-16">
                            <div className="glass-panel p-6 rounded-2xl relative overflow-hidden group hover:border-emerald-500/30 transition-colors">
                                <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                    <Activity size={100} />
                                </div>
                                <h3 className="text-xl font-bold text-emerald-400 mb-3">LUFS 是什麼？</h3>
                                <p className="text-slate-300 text-sm leading-relaxed">
                                    <strong>Loudness Units Full Scale</strong>。<br />
                                    傳統的 dBFS (Peak) 只能測量電流/電壓的最大值，但不能代表「人耳聽起來有多大聲」。<br />
                                    LUFS 考慮了人耳對不同頻率的敏感度（K-weighting），是目前全球通用的響度標準。
                                </p>
                            </div>

                            <div className="glass-panel p-6 rounded-2xl relative overflow-hidden group hover:border-cyan-500/30 transition-colors">
                                <h3 className="text-xl font-bold text-cyan-400 mb-3">Peak vs True Peak</h3>
                                <p className="text-slate-300 text-sm leading-relaxed">
                                    <strong>Sample Peak</strong>: 數位樣本的最大值。<br />
                                    <strong>True Peak (dBTP)</strong>: 考慮數位訊號轉類比 (D/A) 時可能產生的「樣本間峰值」。<br />
                                    <span className="text-red-400 block mt-2 font-bold text-xs"><Info size={12} className="inline mr-1" /> 防止爆音：串流平台通常要求 True Peak 低於 -1.0 dBTP。</span>
                                </p>
                            </div>

                            <div className="glass-panel p-6 rounded-2xl relative overflow-hidden group hover:border-purple-500/30 transition-colors">
                                <h3 className="text-xl font-bold text-purple-400 mb-3">三種測量模式</h3>
                                <ul className="text-sm text-slate-300 space-y-2">
                                    <li className="flex gap-2">
                                        <span className="bg-slate-700 px-1 rounded text-xs font-mono h-fit">M</span>
                                        <span><strong>Momentary</strong>: 瞬時響度 (400ms)。反應極快，用於觀察當下細節。</span>
                                    </li>
                                    <li className="flex gap-2">
                                        <span className="bg-slate-700 px-1 rounded text-xs font-mono h-fit">S</span>
                                        <span><strong>Short-term</strong>: 短期響度 (3秒)。觀察一個樂句或對白的響度。</span>
                                    </li>
                                    <li className="flex gap-2">
                                        <span className="bg-slate-700 px-1 rounded text-xs font-mono h-fit">I</span>
                                        <span><strong>Integrated</strong>: 整合響度。<strong>最重要的數值</strong>，代表「整首曲子/整部片」從頭到尾的平均。</span>
                                    </li>
                                </ul>
                            </div>
                        </section>

                        {/* SECTION 2: INTERACTIVE LAB */}
                        <section className="bg-slate-900 rounded-3xl p-8 border border-slate-800 shadow-2xl mb-16 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 via-cyan-500 to-purple-500"></div>

                            <div className="flex flex-col md:flex-row gap-12 items-end">

                                {/* Controls */}
                                <div className="flex-1 w-full">
                                    <h2 className="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                                        <Activity className="text-emerald-400" /> 響度表模擬器（非真的偵測）
                                    </h2>

                                    <div className="bg-slate-800/50 p-6 rounded-xl border border-slate-700 mb-6">
                                        <label className="text-sm text-slate-400 font-bold mb-2 block">輸入音量 (Input Volume)</label>
                                        <input
                                            type="range"
                                            min="-60"
                                            max="0"
                                            step="0.5"
                                            value={inputGain}
                                            onChange={(e) => setInputGain(parseFloat(e.target.value))}
                                            className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500 mb-4"
                                        />
                                        <div className="flex justify-between items-center">
                                            <span className="font-mono text-2xl font-bold text-emerald-400">{inputGain.toFixed(1)} <span className="text-xs text-slate-500">LUFS</span></span>
                                            <div className="flex gap-3">
                                                <button
                                                    onClick={() => { setInputGain(-14); if (!isPlaying) togglePlay(); }}
                                                    className="px-3 py-1 bg-slate-700 rounded text-xs hover:bg-slate-600 transition"
                                                >
                                                    Set to -14 (YouTube)
                                                </button>
                                                <button
                                                    onClick={() => { setInputGain(-23); if (!isPlaying) togglePlay(); }}
                                                    className="px-3 py-1 bg-slate-700 rounded text-xs hover:bg-slate-600 transition"
                                                >
                                                    Set to -23 (TV)
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex gap-4">
                                        <button
                                            onClick={togglePlay}
                                            className={`flex-1 py-4 rounded-xl font-bold text-lg shadow-lg transition-transform active:scale-95 ${isPlaying ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-emerald-500 hover:bg-emerald-600 text-white'}`}
                                        >
                                            {isPlaying ? '停止測量 (Stop)' : '開始測量 (Start)'}
                                        </button>
                                        <button
                                            onClick={resetMeters}
                                            className="px-6 rounded-xl bg-slate-800 border border-slate-600 hover:bg-slate-700 text-slate-300 transition-colors"
                                            title="Reset Integrated"
                                        >
                                            <RefreshCw size={20} />
                                        </button>
                                    </div>

                                    <div className="mt-6 text-sm text-slate-500 leading-relaxed bg-slate-950/30 p-4 rounded-lg">
                                        <p><strong className="text-slate-300">觀察重點：</strong></p>
                                        <ul className="list-disc list-inside mt-2 space-y-1">
                                            <li>調整 Input 拉桿時，<strong>M</strong> (瞬時) 會立刻改變。</li>
                                            <li><strong>S</strong> (短期) 會稍微慢一點跟上 (有慣性)。</li>
                                            <li><strong>I</strong> (整合) 會受到之前的音量影響，改變最慢，因為它是平均值。</li>
                                            <li>試著忽大忽小，觀察 <strong>Integration</strong> 如何慢慢被拉回平均。</li>
                                        </ul>
                                    </div>
                                </div>

                                {/* Meters Visualization */}
                                <div className="flex gap-2 md:gap-6 h-[400px] bg-slate-950 p-6 rounded-xl border border-slate-800 shadow-inner relative justify-center">

                                    {/* Grid Lines */}
                                    <div className="absolute inset-0 pointer-events-none z-10 flex flex-col justify-between py-6 px-6 opacity-30">
                                        {[0, -14, -23, -40, -60].map(val => (
                                            <div key={val} className="w-full border-t border-slate-500 relative h-0">
                                                <span className="absolute -left-6 -top-2 text-[10px] text-slate-400 w-4 text-right">{val}</span>
                                            </div>
                                        ))}
                                    </div>

                                    {/* M: Momentary */}
                                    <div className="flex flex-col items-center w-12 z-20">
                                        <div className="flex-1 w-full bg-slate-900 rounded-t-lg relative overflow-hidden border border-slate-700">
                                            <div
                                                className={`absolute bottom-0 w-full rounded-t-sm meter-bar ${getBarColor(momentary)}`}
                                                style={{ height: `${getBarHeight(momentary)}%` }}
                                            ></div>
                                        </div>
                                        <div className="mt-2 text-center">
                                            <div className="text-xs font-bold text-slate-300">M</div>
                                            <div className="text-[10px] text-slate-500">LUFS</div>
                                        </div>
                                    </div>

                                    {/* S: Short-term */}
                                    <div className="flex flex-col items-center w-12 z-20">
                                        <div className="flex-1 w-full bg-slate-900 rounded-t-lg relative overflow-hidden border border-slate-700">
                                            <div
                                                className={`absolute bottom-0 w-full rounded-t-sm meter-bar slow ${getBarColor(shortTerm)}`}
                                                style={{ height: `${getBarHeight(shortTerm)}%` }}
                                            ></div>
                                        </div>
                                        <div className="mt-2 text-center">
                                            <div className="text-xs font-bold text-slate-300">S</div>
                                            <div className="text-[10px] text-slate-500">LUFS</div>
                                        </div>
                                    </div>

                                    {/* I: Integrated (Big) */}
                                    <div className="flex flex-col items-center w-20 z-20 mx-2">
                                        <div className="flex-1 w-full bg-slate-900 rounded-t-lg relative overflow-hidden border-2 border-slate-600 bg-slate-800/50">
                                            <div
                                                className={`absolute bottom-0 w-full meter-bar integrated ${getBarColor(integrated)}`}
                                                style={{ height: `${getBarHeight(integrated)}%` }}
                                            ></div>
                                            {/* Numeric Readout Overlay */}
                                            <div className="absolute top-4 w-full text-center">
                                                <div className="text-[10px] text-slate-400 uppercase tracking-widest mb-1">Integrated</div>
                                                <div className="text-lg font-mono font-bold text-white drop-shadow-md">
                                                    {integrated > -99 ? integrated.toFixed(1) : '--'}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="mt-2 text-center">
                                            <div className="text-sm font-bold text-white">I (整合)</div>
                                            <div className="text-[10px] text-slate-500">LUFS</div>
                                        </div>
                                    </div>

                                    {/* TP: True Peak */}
                                    <div className="flex flex-col items-center w-8 z-20 ml-2">
                                        <div className="flex-1 w-2 bg-slate-900 rounded-full relative overflow-hidden border border-slate-700">
                                            {/* Peak hold dot */}
                                            <div
                                                className={`absolute w-full h-1.5 rounded-full transition-all duration-75 ${truePeak > -1.0 ? 'bg-red-500' : 'bg-yellow-400'}`}
                                                style={{ bottom: `${getBarHeight(truePeak)}%` }}
                                            ></div>
                                        </div>
                                        <div className="mt-2 text-center">
                                            <div className="text-[10px] font-bold text-slate-400">TP</div>
                                            <div className="text-[10px] text-slate-600">dB</div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </section>

                        {/* SECTION 3: PLATFORM STANDARDS */}
                        <section>
                            <h2 className="text-3xl font-bold text-white mb-8 border-l-4 border-emerald-500 pl-4">各平台響度標準 (Loudness Standards)</h2>

                            <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-4">

                                {/* YouTube / Spotify */}
                                <div className="bg-slate-800/50 p-6 rounded-xl border-t-4 border-red-500 hover:bg-slate-800 transition-colors">
                                    <div className="flex justify-between items-start mb-4">
                                        <Youtube className="text-red-500" size={32} />
                                        <span className="text-xs font-mono bg-slate-900 px-2 py-1 rounded text-slate-400">Web / Streaming</span>
                                    </div>
                                    <h3 className="text-lg font-bold text-white mb-1">YouTube</h3>
                                    <div className="text-3xl font-mono font-bold text-emerald-400 my-2">-14 <span className="text-sm text-slate-500">LUFS</span></div>
                                    <p className="text-sm text-slate-400">
                                        Spotify, Apple Music 也多在 -14 ~ -16 LUFS 之間。<br />
                                        超過會被強制轉小聲 (Normalization)。
                                    </p>
                                </div>

                                {/* Podcast */}
                                <div className="bg-slate-800/50 p-6 rounded-xl border-t-4 border-indigo-500 hover:bg-slate-800 transition-colors">
                                    <div className="flex justify-between items-start mb-4">
                                        <Mic className="text-indigo-500" size={32} />
                                        <span className="text-xs font-mono bg-slate-900 px-2 py-1 rounded text-slate-400">Mobile / Voice</span>
                                    </div>
                                    <h3 className="text-lg font-bold text-white mb-1">Podcast</h3>
                                    <div className="text-3xl font-mono font-bold text-indigo-400 my-2">-16 <span className="text-sm text-slate-500">LUFS</span></div>
                                    <p className="text-sm text-slate-400">
                                        Apple Podcasts 建議標準。<br />
                                        比音樂平台稍小，保留人聲動態，適合行動裝置聆聽。
                                    </p>
                                </div>

                                {/* Netflix / OTT */}
                                <div className="bg-slate-800/50 p-6 rounded-xl border-t-4 border-slate-200 hover:bg-slate-800 transition-colors">
                                    <div className="flex justify-between items-start mb-4">
                                        <Laptop className="text-slate-200" size={32} />
                                        <span className="text-xs font-mono bg-slate-900 px-2 py-1 rounded text-slate-400">OTT / Drama</span>
                                    </div>
                                    <h3 className="text-lg font-bold text-white mb-1">Netflix</h3>
                                    <div className="text-3xl font-mono font-bold text-cyan-400 my-2">-27 <span className="text-sm text-slate-500">LKFS</span></div>
                                    <p className="text-sm text-slate-400">
                                        使用對白加權 (Dialogue-gated)。<br />
                                        非常嚴格，超過容許範圍 (-27 ± 2) 會被退件。
                                    </p>
                                </div>

                                {/* Broadcast / TV */}
                                <div className="bg-slate-800/50 p-6 rounded-xl border-t-4 border-orange-500 hover:bg-slate-800 transition-colors">
                                    <div className="flex justify-between items-start mb-4">
                                        <Tv className="text-orange-500" size={32} />
                                        <span className="text-xs font-mono bg-slate-900 px-2 py-1 rounded text-slate-400">Broadcast</span>
                                    </div>
                                    <h3 className="text-lg font-bold text-white mb-1">TV (EBU R128)</h3>
                                    <div className="text-3xl font-mono font-bold text-orange-400 my-2">-23 <span className="text-sm text-slate-500">LUFS</span></div>
                                    <p className="text-sm text-slate-400">
                                        歐洲電視標準 (EBU R128)。<br />
                                        美國電視 (ATSC A/85) 則為 -24 LKFS。<br />
                                        動態範圍最大。
                                    </p>
                                </div>

                            </div>

                            <div className="mt-8 p-4 bg-slate-900 rounded-lg border border-slate-700 text-sm text-slate-400 flex flex-col md:flex-row gap-4 items-center">
                                <Info className="text-emerald-500 flex-shrink-0" />
                                <p>
                                    <strong>True Peak 限制：</strong> 所有的串流平台通常建議 True Peak 不要超過 <strong>-1.0 dBTP</strong> (有些嚴格至 -2.0)，以避免在 MP3/AAC 壓縮轉檔時產生失真。
                                </p>
                                <a
                                    href="https://tech.ebu.ch/loudness"
                                    target="_blank"
                                    className="ml-auto px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded transition text-xs whitespace-nowrap"
                                >
                                    EBU R128 官方文件 ↗
                                </a>
                            </div>
                        </section>

                    </div>

                    {/* Footer */}
                    <footer className="mt-20 border-t border-slate-800 py-8 text-center text-slate-500 text-sm">
                        <p>義守大學電影與電視學系陳嘉暐老師課程提供</p>
                    </footer>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LoudnessLab />);
    </script>
</body>

</html>